<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<meta property="og:title" content="C&#43;&#43; Virtual Table - Explained thru Assemblies" />
<meta property="og:description" content="C&#43;&#43; Virtual Table Code C&#43;&#43; Sources #include &lt;string&gt;#include &lt;iostream&gt; class Base { public: virtual const char* Name() const { return &#34;Base&#34;; } virtual const char* BaseName() const { return &#34;Base&#34;; } int a = 1; int t = 2; }; class DerivedC : public Base { public: virtual const char* Name() const override { return &#34;Derived&#34;; } int b = 3; double c = 4.0; }; int main() { Base* base = new DerivedC; base-&gt;Name(); base-&gt;BaseName(); delete base; return 0; } Compiled Assemblies ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://xuhongxu.com/en/2019/05/c-virtual-table-explained-thru-assemblies/" />
<meta property="article:published_time" content="2019-05-04T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-05-04T00:00:00+00:00" /><meta property="og:site_name" content="Xu Xu" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="C&#43;&#43; Virtual Table - Explained thru Assemblies"/>
<meta name="twitter:description" content="C&#43;&#43; Virtual Table Code C&#43;&#43; Sources #include &lt;string&gt;#include &lt;iostream&gt; class Base { public: virtual const char* Name() const { return &#34;Base&#34;; } virtual const char* BaseName() const { return &#34;Base&#34;; } int a = 1; int t = 2; }; class DerivedC : public Base { public: virtual const char* Name() const override { return &#34;Derived&#34;; } int b = 3; double c = 4.0; }; int main() { Base* base = new DerivedC; base-&gt;Name(); base-&gt;BaseName(); delete base; return 0; } Compiled Assemblies ."/>



  <link rel="canonical" href="https://xuhongxu.com/en/2019/05/c-virtual-table-explained-thru-assemblies/">

  <title>
    
    C&#43;&#43; Virtual Table - Explained thru Assemblies | Xu Xu
    
  </title>

  
  <link rel="stylesheet" href="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/css/bootstrap.css"
    crossorigin="anonymous">

  <link href="https://xuhongxu.com/css/style.css" rel="stylesheet">

  

  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-69634713-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

  

</head>

<body>
  
  <header class="blog-header">
    <nav class="navbar navbar-expand-md navbar-light bg-light">
        <a class="navbar-brand" href="/en">
            Xu Xu
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false"
            aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarNav">
            <ul class="navbar-nav">
                
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/en">Home</a>
                    
                </li>
                
                <li class="nav-item ">
                    
                        <a class="nav-link" href="/en/about/">About</a>
                    
                </li>
                
            </ul>
            
            <ul class="navbar-nav">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                        Language
                    </a>
                    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown">
                        
                            <a class="dropdown-item" href="https://xuhongxu.com/">简体中文</a>
                        
                            <a class="dropdown-item" href="https://xuhongxu.com/en/">English</a>
                        
                    </div>
                </li>
            </ul>
            
        </div>
    </nav>
</header>
  

  
  
    <div class="container">
      
      <div class="row">
        <div class="col-12 col-lg-8 blog-main">

          

<header>
    <h2 class="blog-post-title">
        <a class="text-dark" href="/en/2019/05/c-virtual-table-explained-thru-assemblies/">C++ Virtual Table - Explained thru Assemblies</a>
    </h2>
    


<div class="blog-post-date text-secondary">
    
        May 4, 2019
    
    
        by <span rel="author">Hongxu Xu</span>
    
</div>

    
<div class="blog-post-tags text-secondary">
    <strong>Tags:</strong>
    
        <a class="badge badge-primary" href="/en/tags/cpp">cpp</a>
    
        <a class="badge badge-primary" href="/en/tags/virtual-table">virtual table</a>
    
</div>

    
<div class="blog-post-categories text-secondary">
    <strong>Categories:</strong>
    
        <a class="badge badge-primary" href="/en/categories/cpp">cpp</a>
    
</div>

    <hr>
</header>
<article class="blog-post">
    <h1 id="c-virtual-table">C++ Virtual Table</h1>
<h2 id="code">Code</h2>
<h3 id="c-sources">C++ Sources</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Base</span> {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> Name() <span style="color:#66d9ef">const</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Base&#34;</span>;
    }

    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">BaseName</span>() <span style="color:#66d9ef">const</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Base&#34;</span>;
    }

    <span style="color:#66d9ef">int</span> a <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
    <span style="color:#66d9ef">int</span> t <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
};

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DerivedC</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> Base {
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> Name() <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">override</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Derived&#34;</span>;
    }

    <span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
    <span style="color:#66d9ef">double</span> c <span style="color:#f92672">=</span> <span style="color:#ae81ff">4.0</span>;
};

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    Base<span style="color:#f92672">*</span> base <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DerivedC;

    base<span style="color:#f92672">-&gt;</span>Name();
    base<span style="color:#f92672">-&gt;</span>BaseName();

    <span style="color:#66d9ef">delete</span> base;
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><h3 id="compiled-assemblies">Compiled Assemblies</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">.LC0:
        <span style="color:#a6e22e">.string</span> <span style="color:#e6db74">&#34;Base&#34;</span>
Base:<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#a6e22e">Name</span>() <span style="color:#66d9ef">const</span>:
        <span style="color:#a6e22e">pushq</span>   %rbp
        <span style="color:#a6e22e">movq</span>    %rsp, %rbp
        <span style="color:#a6e22e">movq</span>    %rdi, -<span style="color:#ae81ff">8</span>(%rbp)
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$.LC0</span>, %eax
        <span style="color:#a6e22e">popq</span>    %rbp
        <span style="color:#a6e22e">ret</span>
Base:<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#a6e22e">BaseName</span>() <span style="color:#66d9ef">const</span>:
        <span style="color:#a6e22e">pushq</span>   %rbp
        <span style="color:#a6e22e">movq</span>    %rsp, %rbp
        <span style="color:#a6e22e">movq</span>    %rdi, -<span style="color:#ae81ff">8</span>(%rbp)
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$.LC0</span>, %eax
        <span style="color:#a6e22e">popq</span>    %rbp
        <span style="color:#a6e22e">ret</span>
.LC1:
        <span style="color:#a6e22e">.string</span> <span style="color:#e6db74">&#34;Derived&#34;</span>
DerivedC:<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#a6e22e">Name</span>() <span style="color:#66d9ef">const</span>:
        <span style="color:#a6e22e">pushq</span>   %rbp
        <span style="color:#a6e22e">movq</span>    %rsp, %rbp
        <span style="color:#a6e22e">movq</span>    %rdi, -<span style="color:#ae81ff">8</span>(%rbp)
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$.LC1</span>, %eax
        <span style="color:#a6e22e">popq</span>    %rbp
        <span style="color:#a6e22e">ret</span>
Base:<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#a6e22e">Base</span>() [<span style="color:#66d9ef">base</span> <span style="color:#66d9ef">object</span> <span style="color:#66d9ef">constructor</span>]:
        <span style="color:#a6e22e">pushq</span>   %rbp
        <span style="color:#a6e22e">movq</span>    %rsp, %rbp
        <span style="color:#a6e22e">movq</span>    %rdi, -<span style="color:#ae81ff">8</span>(%rbp)
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$vtable</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">Base</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">16</span>, %edx
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movq</span>    %rdx, (%rax)
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$1</span>, <span style="color:#ae81ff">8</span>(%rax)
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$2</span>, <span style="color:#ae81ff">12</span>(%rax)
        <span style="color:#a6e22e">nop</span>
        <span style="color:#a6e22e">popq</span>    %rbp
        <span style="color:#a6e22e">ret</span>
DerivedC:<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#a6e22e">DerivedC</span>() [<span style="color:#66d9ef">base</span> <span style="color:#66d9ef">object</span> <span style="color:#66d9ef">constructor</span>]:
        <span style="color:#a6e22e">pushq</span>   %rbp
        <span style="color:#a6e22e">movq</span>    %rsp, %rbp
        <span style="color:#a6e22e">subq</span>    <span style="color:#66d9ef">$16</span>, %rsp
        <span style="color:#a6e22e">movq</span>    %rdi, -<span style="color:#ae81ff">8</span>(%rbp)
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movq</span>    %rax, %rdi
        <span style="color:#a6e22e">call</span>    <span style="color:#66d9ef">Base</span>::<span style="color:#66d9ef">Base</span>() [<span style="color:#66d9ef">base</span> <span style="color:#66d9ef">object</span> <span style="color:#66d9ef">constructor</span>]
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$vtable</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">DerivedC</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">16</span>, %edx
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movq</span>    %rdx, (%rax)
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$3</span>, <span style="color:#ae81ff">16</span>(%rax)
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movsd</span>   <span style="color:#66d9ef">.LC2</span>(%rip), %xmm0
        <span style="color:#a6e22e">movsd</span>   %xmm0, <span style="color:#ae81ff">24</span>(%rax)
        <span style="color:#a6e22e">nop</span>
        <span style="color:#a6e22e">leave</span>
        <span style="color:#a6e22e">ret</span>
main:
        <span style="color:#a6e22e">pushq</span>   %rbp
        <span style="color:#a6e22e">movq</span>    %rsp, %rbp
        <span style="color:#a6e22e">pushq</span>   %rbx
        <span style="color:#a6e22e">subq</span>    <span style="color:#66d9ef">$24</span>, %rsp
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$32</span>, %edi
        <span style="color:#a6e22e">call</span>    <span style="color:#66d9ef">operator</span> <span style="color:#66d9ef">new</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)
        <span style="color:#a6e22e">movq</span>    %rax, %rbx
        <span style="color:#a6e22e">movq</span>    %rbx, %rdi
        <span style="color:#a6e22e">call</span>    <span style="color:#66d9ef">DerivedC</span>::<span style="color:#66d9ef">DerivedC</span>() [<span style="color:#66d9ef">complete</span> <span style="color:#66d9ef">object</span> <span style="color:#66d9ef">constructor</span>]
        <span style="color:#a6e22e">movq</span>    %rbx, -<span style="color:#ae81ff">24</span>(%rbp)
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">24</span>(%rbp), %rax
        <span style="color:#a6e22e">movq</span>    (%rax), %rax
        <span style="color:#a6e22e">movq</span>    (%rax), %rax
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">24</span>(%rbp), %rdx
        <span style="color:#a6e22e">movq</span>    %rdx, %rdi
        <span style="color:#a6e22e">call</span>    *%rax
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">24</span>(%rbp), %rax
        <span style="color:#a6e22e">movq</span>    (%rax), %rax
        <span style="color:#a6e22e">addq</span>    <span style="color:#66d9ef">$8</span>, %rax
        <span style="color:#a6e22e">movq</span>    (%rax), %rax
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">24</span>(%rbp), %rdx
        <span style="color:#a6e22e">movq</span>    %rdx, %rdi
        <span style="color:#a6e22e">call</span>    *%rax
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">24</span>(%rbp), %rax
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$16</span>, %esi
        <span style="color:#a6e22e">movq</span>    %rax, %rdi
        <span style="color:#a6e22e">call</span>    <span style="color:#66d9ef">operator</span> <span style="color:#66d9ef">delete</span>(<span style="color:#66d9ef">void</span>*, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$0</span>, %eax
        <span style="color:#a6e22e">addq</span>    <span style="color:#66d9ef">$24</span>, %rsp
        <span style="color:#a6e22e">popq</span>    %rbx
        <span style="color:#a6e22e">popq</span>    %rbp
        <span style="color:#a6e22e">ret</span>
<span style="color:#a6e22e">vtable</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">DerivedC</span>:
        <span style="color:#a6e22e">.quad</span>   <span style="color:#ae81ff">0</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">typeinfo</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">DerivedC</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">DerivedC</span>::<span style="color:#66d9ef">Name</span>() <span style="color:#66d9ef">const</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">Base</span>::<span style="color:#66d9ef">BaseName</span>() <span style="color:#66d9ef">const</span>
<span style="color:#a6e22e">vtable</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">Base</span>:
        <span style="color:#a6e22e">.quad</span>   <span style="color:#ae81ff">0</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">typeinfo</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">Base</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">Base</span>::<span style="color:#66d9ef">Name</span>() <span style="color:#66d9ef">const</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">Base</span>::<span style="color:#66d9ef">BaseName</span>() <span style="color:#66d9ef">const</span>
<span style="color:#a6e22e">typeinfo</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">DerivedC</span>:
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">vtable</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">__cxxabiv1</span>::<span style="color:#66d9ef">__si_class_type_info</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">16</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">typeinfo</span> <span style="color:#66d9ef">name</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">DerivedC</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">typeinfo</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">Base</span>
<span style="color:#a6e22e">typeinfo</span> <span style="color:#66d9ef">name</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">DerivedC</span>:
        <span style="color:#a6e22e">.string</span> <span style="color:#e6db74">&#34;8DerivedC&#34;</span>
<span style="color:#a6e22e">typeinfo</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">Base</span>:
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">vtable</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">__cxxabiv1</span>::<span style="color:#66d9ef">__class_type_info</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">16</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">typeinfo</span> <span style="color:#66d9ef">name</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">Base</span>
<span style="color:#a6e22e">typeinfo</span> <span style="color:#66d9ef">name</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">Base</span>:
        <span style="color:#a6e22e">.string</span> <span style="color:#e6db74">&#34;4Base&#34;</span>
.LC2:
        <span style="color:#a6e22e">.long</span>   <span style="color:#ae81ff">0</span>
        <span style="color:#a6e22e">.long</span>   <span style="color:#ae81ff">1074790400</span>
</code></pre></div><h2 id="analysis">Analysis</h2>
<h3 id="basebase"><code>Base::Base()</code></h3>
<p>Default constructor for <code>Base</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">Base:<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#a6e22e">Base</span>() [<span style="color:#66d9ef">base</span> <span style="color:#66d9ef">object</span> <span style="color:#66d9ef">constructor</span>]:
        <span style="color:#a6e22e">pushq</span>   %rbp
        <span style="color:#a6e22e">movq</span>    %rsp, %rbp
        <span style="color:#a6e22e">movq</span>    %rdi, -<span style="color:#ae81ff">8</span>(%rbp)
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$vtable</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">Base</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">16</span>, %edx
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movq</span>    %rdx, (%rax)
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$1</span>, <span style="color:#ae81ff">8</span>(%rax)
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$2</span>, <span style="color:#ae81ff">12</span>(%rax)
        <span style="color:#a6e22e">nop</span>
        <span style="color:#a6e22e">popq</span>    %rbp
        <span style="color:#a6e22e">ret</span>
</code></pre></div><ol>
<li>
<p>Init Stack Frame</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">        <span style="color:#a6e22e">pushq</span>   %rbp
        <span style="color:#a6e22e">movq</span>    %rsp, %rbp
</code></pre></div></li>
<li>
<p>Save the 1st Passed-In Parameter to Stack <code>-8(%rbp)</code>: Address to <code>this</code> in <code>%rdi</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">        <span style="color:#a6e22e">movq</span>    %rdi, -<span style="color:#ae81ff">8</span>(%rbp)
</code></pre></div></li>
<li>
<p>Move the Virtual Table Address to <code>%edx</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$vtable</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">Base</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">16</span>, %edx

        <span style="color:#a6e22e">...</span>

<span style="color:#a6e22e">vtable</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">Base</span>:
        <span style="color:#a6e22e">.quad</span>   <span style="color:#ae81ff">0</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">typeinfo</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">Base</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">Base</span>::<span style="color:#66d9ef">Name</span>() <span style="color:#66d9ef">const</span>      <span style="color:#75715e">; &lt;-- %edx is pointed to here
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">.quad</span>   <span style="color:#66d9ef">Base</span>::<span style="color:#66d9ef">BaseName</span>() <span style="color:#66d9ef">const</span>
</code></pre></div><blockquote>
<p>Each <code>.quad</code> is data of 4 bytes, so <code>%edx</code> is pointed to the third line in <code>vtable for Base</code> (where the offset is <code>&quot;+16&quot;</code>).</p>
</blockquote>
</li>
<li>
<p>Save the Address of Virtual Table to <code>this</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movq</span>    %rdx, (%rax)
</code></pre></div><p>The 1st instruction moves the address to <code>this</code> to <code>%rax</code>.<br>
And the 2nd instruction moves <code>%rdx</code> which contains the <code>%edx (vtable address)</code> to the location indicated by <code>%rax</code> (that&rsquo;s <code>this</code>).</p>
</li>
<li>
<p>Assign the Member Variables</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$1</span>, <span style="color:#ae81ff">8</span>(%rax)

        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$2</span>, <span style="color:#ae81ff">12</span>(%rax)
</code></pre></div><p>The same as step 4, <code>%rax</code> stores the address to <code>this</code>, and the immediates <code>$1</code> and <code>$2</code> will be saved to the adjacent positions (+8, +12) in <code>$rax</code> (<code>this</code>).</p>
</li>
<li>
<p>Restore the Stack Frame and Return</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">        <span style="color:#a6e22e">popq</span>    %rbp
        <span style="color:#a6e22e">ret</span>
</code></pre></div></li>
</ol>
<h4 id="layout-in-memory">Layout in Memory</h4>
<pre><code>this    -&gt;      vtable for Base + 16
this+8  -&gt;      1 (int a)
this+12 -&gt;      2 (int t)
</code></pre><h3 id="derivedcderivedc"><code>DerivedC::DerivedC()</code></h3>
<p>Default constructor for <code>DerivedC</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">DerivedC:<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#a6e22e">DerivedC</span>() [<span style="color:#66d9ef">base</span> <span style="color:#66d9ef">object</span> <span style="color:#66d9ef">constructor</span>]:
        <span style="color:#a6e22e">pushq</span>   %rbp
        <span style="color:#a6e22e">movq</span>    %rsp, %rbp
        <span style="color:#a6e22e">subq</span>    <span style="color:#66d9ef">$16</span>, %rsp
        <span style="color:#a6e22e">movq</span>    %rdi, -<span style="color:#ae81ff">8</span>(%rbp)
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movq</span>    %rax, %rdi
        <span style="color:#a6e22e">call</span>    <span style="color:#66d9ef">Base</span>::<span style="color:#66d9ef">Base</span>() [<span style="color:#66d9ef">base</span> <span style="color:#66d9ef">object</span> <span style="color:#66d9ef">constructor</span>]
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$vtable</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">DerivedC</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">16</span>, %edx
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movq</span>    %rdx, (%rax)
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$3</span>, <span style="color:#ae81ff">16</span>(%rax)
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movsd</span>   <span style="color:#66d9ef">.LC2</span>(%rip), %xmm0
        <span style="color:#a6e22e">movsd</span>   %xmm0, <span style="color:#ae81ff">24</span>(%rax)
        <span style="color:#a6e22e">nop</span>
        <span style="color:#a6e22e">leave</span>
        <span style="color:#a6e22e">ret</span>
</code></pre></div><ol>
<li>
<p>Init Stack Frame</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">        <span style="color:#a6e22e">pushq</span>   %rbp
        <span style="color:#a6e22e">movq</span>    %rsp, %rbp

        <span style="color:#a6e22e">subq</span>    <span style="color:#66d9ef">$16</span>, %rsp
</code></pre></div><p>The last instruction preserves 16 bytes in stack.</p>
<blockquote>
<p>x64 needs stack to align to 16 bytes. So here rsp is subtracted by 16 bytes even though only 8 bytes are used.</p>
</blockquote>
</li>
<li>
<p>Save the 1st Passed-In Parameter <code>this</code> to Stack</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">        <span style="color:#a6e22e">movq</span>    %rdi, -<span style="color:#ae81ff">8</span>(%rbp)
</code></pre></div></li>
<li>
<p>Set the 1st Parameter (<code>this</code>) for Function Call to <code>Base::Base()</code> and Call It</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movq</span>    %rax, %rdi

        <span style="color:#a6e22e">call</span>    <span style="color:#66d9ef">Base</span>::<span style="color:#66d9ef">Base</span>() [<span style="color:#66d9ef">base</span> <span style="color:#66d9ef">object</span> <span style="color:#66d9ef">constructor</span>]
</code></pre></div></li>
<li>
<p>Save Virtual Table Address to <code>this</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$vtable</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">DerivedC</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">16</span>, %edx
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movq</span>    %rdx, (%rax)
   
        <span style="color:#a6e22e">...</span>

<span style="color:#a6e22e">vtable</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">DerivedC</span>:
        <span style="color:#a6e22e">.quad</span>   <span style="color:#ae81ff">0</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">typeinfo</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">DerivedC</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">DerivedC</span>::<span style="color:#66d9ef">Name</span>() <span style="color:#66d9ef">const</span>      <span style="color:#75715e">; &lt;-- %edx is pointed to here 
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">.quad</span>   <span style="color:#66d9ef">Base</span>::<span style="color:#66d9ef">BaseName</span>() <span style="color:#66d9ef">const</span>
</code></pre></div></li>
<li>
<p>Assign the Member Variables</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$3</span>, <span style="color:#ae81ff">16</span>(%rax)
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">8</span>(%rbp), %rax
        <span style="color:#a6e22e">movsd</span>   <span style="color:#66d9ef">.LC2</span>(%rip), %xmm0
        <span style="color:#a6e22e">movsd</span>   %xmm0, <span style="color:#ae81ff">24</span>(%rax)
</code></pre></div></li>
<li>
<p>Restore the Stack Frame and Return</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">        <span style="color:#a6e22e">leave</span>
        <span style="color:#a6e22e">ret</span>
</code></pre></div><blockquote>
<p><code>leave</code> = <code>mov %ebp, %esp</code> and <code>pop %ebp</code></p>
</blockquote>
</li>
</ol>
<h4 id="layout-in-memory-1">Layout in Memory</h4>
<pre><code>this    -&gt;      vtable for DerivedC + 16
this+8  -&gt;      1 (int a from Base)
this+12 -&gt;      2 (int t from Base)
this+16 -&gt;      3 (int b)
this+24 -&gt;      4.0 (double c)
</code></pre><h3 id="basename-basebasename"><code>Base::Name()</code>, <code>Base::BaseName()</code></h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">Name</span>() <span style="color:#66d9ef">const</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Base&#34;</span>;
}

<span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">BaseName</span>() <span style="color:#66d9ef">const</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Base&#34;</span>;
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">.LC0:
        <span style="color:#a6e22e">.string</span> <span style="color:#e6db74">&#34;Base&#34;</span>

Base:<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#a6e22e">Name</span>() <span style="color:#66d9ef">const</span>:
        <span style="color:#a6e22e">pushq</span>   %rbp
        <span style="color:#a6e22e">movq</span>    %rsp, %rbp
        <span style="color:#a6e22e">movq</span>    %rdi, -<span style="color:#ae81ff">8</span>(%rbp)
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$.LC0</span>, %eax
        <span style="color:#a6e22e">popq</span>    %rbp
        <span style="color:#a6e22e">ret</span>

Base:<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#a6e22e">BaseName</span>() <span style="color:#66d9ef">const</span>:
        <span style="color:#a6e22e">pushq</span>   %rbp
        <span style="color:#a6e22e">movq</span>    %rsp, %rbp
        <span style="color:#a6e22e">movq</span>    %rdi, -<span style="color:#ae81ff">8</span>(%rbp)
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$.LC0</span>, %eax
        <span style="color:#a6e22e">popq</span>    %rbp
        <span style="color:#a6e22e">ret</span>
</code></pre></div><p>They are the same.</p>
<p>Apart from instructions about Stack Frame, there are only 2 instructions left:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">        <span style="color:#a6e22e">movq</span>    %rdi, -<span style="color:#ae81ff">8</span>(%rbp)
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$.LC0</span>, %eax
</code></pre></div><ol>
<li>Save the 1st Passed-In Parameter <code>this</code> to Stack</li>
<li>Move the <code>$.LC0</code> (the string <code>&quot;Base&quot;</code>) to <code>%eax</code> as Return Value</li>
</ol>
<h3 id="derivedcname"><code>DerivedC::Name()</code></h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">Name</span>() <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">override</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;Derived&#34;</span>;
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">.LC1:
        <span style="color:#a6e22e">.string</span> <span style="color:#e6db74">&#34;Derived&#34;</span>

DerivedC:<span style="color:#960050;background-color:#1e0010">:</span><span style="color:#a6e22e">Name</span>() <span style="color:#66d9ef">const</span>:
        <span style="color:#a6e22e">pushq</span>   %rbp
        <span style="color:#a6e22e">movq</span>    %rsp, %rbp
        <span style="color:#a6e22e">movq</span>    %rdi, -<span style="color:#ae81ff">8</span>(%rbp)
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$.LC1</span>, %eax
        <span style="color:#a6e22e">popq</span>    %rbp
        <span style="color:#a6e22e">ret</span>
</code></pre></div><p>This is the same as <code>Base::Name()</code> except the return value.</p>
<h3 id="main"><code>main()</code></h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
    Base<span style="color:#f92672">*</span> base <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DerivedC;

    base<span style="color:#f92672">-&gt;</span>Name();
    base<span style="color:#f92672">-&gt;</span>BaseName();

    <span style="color:#66d9ef">delete</span> base;
    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
}
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">main:
        <span style="color:#a6e22e">pushq</span>   %rbp
        <span style="color:#a6e22e">movq</span>    %rsp, %rbp
        <span style="color:#a6e22e">pushq</span>   %rbx
        <span style="color:#a6e22e">subq</span>    <span style="color:#66d9ef">$24</span>, %rsp

        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$32</span>, %edi
        <span style="color:#a6e22e">call</span>    <span style="color:#66d9ef">operator</span> <span style="color:#66d9ef">new</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)
        <span style="color:#a6e22e">movq</span>    %rax, %rbx
        <span style="color:#a6e22e">movq</span>    %rbx, %rdi
        <span style="color:#a6e22e">call</span>    <span style="color:#66d9ef">DerivedC</span>::<span style="color:#66d9ef">DerivedC</span>() [<span style="color:#66d9ef">complete</span> <span style="color:#66d9ef">object</span> <span style="color:#66d9ef">constructor</span>]
        <span style="color:#a6e22e">movq</span>    %rbx, -<span style="color:#ae81ff">24</span>(%rbp)

        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">24</span>(%rbp), %rax
        <span style="color:#a6e22e">movq</span>    (%rax), %rax
        <span style="color:#a6e22e">movq</span>    (%rax), %rax
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">24</span>(%rbp), %rdx
        <span style="color:#a6e22e">movq</span>    %rdx, %rdi
        <span style="color:#a6e22e">call</span>    *%rax

        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">24</span>(%rbp), %rax
        <span style="color:#a6e22e">movq</span>    (%rax), %rax
        <span style="color:#a6e22e">addq</span>    <span style="color:#66d9ef">$8</span>, %rax
        <span style="color:#a6e22e">movq</span>    (%rax), %rax
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">24</span>(%rbp), %rdx
        <span style="color:#a6e22e">movq</span>    %rdx, %rdi
        <span style="color:#a6e22e">call</span>    *%rax

        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">24</span>(%rbp), %rax
        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$16</span>, %esi
        <span style="color:#a6e22e">movq</span>    %rax, %rdi
        <span style="color:#a6e22e">call</span>    <span style="color:#66d9ef">operator</span> <span style="color:#66d9ef">delete</span>(<span style="color:#66d9ef">void</span>*, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)

        <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$0</span>, %eax
        <span style="color:#a6e22e">addq</span>    <span style="color:#66d9ef">$24</span>, %rsp
        <span style="color:#a6e22e">popq</span>    %rbx
        <span style="color:#a6e22e">popq</span>    %rbp
        <span style="color:#a6e22e">ret</span>
</code></pre></div><ol>
<li>
<p>Init Stack Frame</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">    <span style="color:#a6e22e">pushq</span>   %rbp
    <span style="color:#a6e22e">movq</span>    %rsp, %rbp
    <span style="color:#a6e22e">pushq</span>   %rbx

    <span style="color:#a6e22e">subq</span>    <span style="color:#66d9ef">$24</span>, %rsp
</code></pre></div></li>
<li>
<p>Allocate <code>DerivedC</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">new</span> DerivedC;
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">    <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$32</span>, %edi
    <span style="color:#a6e22e">call</span>    <span style="color:#66d9ef">operator</span> <span style="color:#66d9ef">new</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)
    <span style="color:#a6e22e">movq</span>    %rax, %rbx
</code></pre></div><p><code>DerivedC</code> occupies 32 bytes, so we pass <code>$32</code> into <code>operator new(unsigned long)</code> to allocate the memory.</p>
<p>The allocated memory address is returned thru <code>$rax</code>, and it&rsquo;s moved to <code>%rbx</code> by the last instruction.</p>
</li>
<li>
<p>Construct <code>DerivedC</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">new</span> DerivedC;
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">    <span style="color:#a6e22e">movq</span>    %rbx, %rdi
    <span style="color:#a6e22e">call</span>    <span style="color:#66d9ef">DerivedC</span>::<span style="color:#66d9ef">DerivedC</span>() [<span style="color:#66d9ef">complete</span> <span style="color:#66d9ef">object</span> <span style="color:#66d9ef">constructor</span>]
</code></pre></div><p>Move the allocated memory address from <code>%rbx</code> to <code>%rdi</code> as the 1st parameter that will be passed into <code>DerivedC::DerivedC()</code>.</p>
</li>
<li>
<p>Assign the pointer to <code>DerivedC</code> to <code>Base* base</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">Base<span style="color:#f92672">*</span> base <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> DerivedC;
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">    <span style="color:#a6e22e">movq</span>    %rbx, -<span style="color:#ae81ff">24</span>(%rbp)
</code></pre></div><p><code>base</code> is stored in stack: <code>-24(%rbp)</code>.</p>
</li>
<li>
<p>Call <code>base-&gt;Name()</code> Overriden Virtual Function</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">base<span style="color:#f92672">-&gt;</span>Name();
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">    <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">24</span>(%rbp), %rax
    <span style="color:#a6e22e">movq</span>    (%rax), %rax
    <span style="color:#a6e22e">movq</span>    (%rax), %rax

    <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">24</span>(%rbp), %rdx
    <span style="color:#a6e22e">movq</span>    %rdx, %rdi

    <span style="color:#a6e22e">call</span>    *%rax
</code></pre></div><ol>
<li>
<p>Move <code>Base* base</code> to <code>%rax</code>.<br>
Now <code>%rax</code> is the address to allocated memory of <code>DerivedC</code>, which is <code>base</code> points to.</p>
</li>
<li>
<p>Load <code>(%rax)</code> (which is <code>*base</code>) to <code>%rax</code>.<br>
As the memory layout of <code>DerivedC</code> is:</p>
<pre><code>this (base) -&gt;      vtable for DerivedC + 16
this+8      -&gt;      1 (int a from Base)
this+12     -&gt;      2 (int t from Base)
this+16     -&gt;      3 (int b)
this+24     -&gt;      4.0 (double c)
</code></pre><p>Memory at <code>base</code> also stores the address to <code>vtable for DerivedC + 16</code>.<br>
So, <code>*base</code> is the address to <code>vtable for DerivedC + 16</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm"><span style="color:#a6e22e">vtable</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">DerivedC</span>:
        <span style="color:#a6e22e">.quad</span>   <span style="color:#ae81ff">0</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">typeinfo</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">DerivedC</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">DerivedC</span>::<span style="color:#66d9ef">Name</span>() <span style="color:#66d9ef">const</span>      <span style="color:#75715e">; Here is *base
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">.quad</span>   <span style="color:#66d9ef">Base</span>::<span style="color:#66d9ef">BaseName</span>() <span style="color:#66d9ef">const</span>
</code></pre></div><p>Now, <code>%rax</code> stores the address to <code>Derived::Name() const</code>.</p>
</li>
<li>
<p>Load <code>(%rax)</code> again to <code>%rax</code>.<br>
Now, <code>%rax</code> is pointed to the method <code>Derived::Name()</code>.</p>
</li>
<li>
<p>Call It thru Method Address</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">        <span style="color:#a6e22e">call</span>    *%rax
</code></pre></div></li>
</ol>
</li>
<li>
<p>Call <code>base-&gt;BaseName()</code> Non-Overriden Virtual Function<br>
This is similar to the previous step.<br>
Only differences are the address we visit in virtual table and the method address in virtual table:</p>
<ol>
<li>
<p>Before loading the method address, it adds <code>$8</code> to vtable address to let <code>$rax</code> points to the address to the 2nd method in vtable.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">24</span>(%rbp), %rax
        <span style="color:#a6e22e">movq</span>    (%rax), %rax

        <span style="color:#a6e22e">addq</span>    <span style="color:#66d9ef">$8</span>, %rax    <span style="color:#75715e">; we visit the 2nd method in vtable
</span><span style="color:#75715e"></span>
        <span style="color:#a6e22e">movq</span>    (%rax), %rax
        <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">24</span>(%rbp), %rdx
        <span style="color:#a6e22e">movq</span>    %rdx, %rdi
        <span style="color:#a6e22e">call</span>    *%rax
</code></pre></div></li>
<li>
<p>Also, because <code>BaseName()</code> isn&rsquo;t overriden by <code>DerivedC</code>, in virtual table, it stores the address to <code>Base::BaseName()</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">    <span style="color:#a6e22e">vtable</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">DerivedC</span>:
        <span style="color:#a6e22e">.quad</span>   <span style="color:#ae81ff">0</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">typeinfo</span> <span style="color:#66d9ef">for</span> <span style="color:#66d9ef">DerivedC</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">DerivedC</span>::<span style="color:#66d9ef">Name</span>() <span style="color:#66d9ef">const</span>
        <span style="color:#a6e22e">.quad</span>   <span style="color:#66d9ef">Base</span>::<span style="color:#66d9ef">BaseName</span>() <span style="color:#66d9ef">const</span>
</code></pre></div></li>
</ol>
</li>
<li>
<p>Delete pointer</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">    <span style="color:#a6e22e">movq</span>    -<span style="color:#ae81ff">24</span>(%rbp), %rax
    <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$16</span>, %esi
    <span style="color:#a6e22e">movq</span>    %rax, %rdi
    <span style="color:#a6e22e">call</span>    <span style="color:#66d9ef">operator</span> <span style="color:#66d9ef">delete</span>(<span style="color:#66d9ef">void</span>*, <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)
</code></pre></div><ol>
<li>Move <code>Base* base</code> to <code>%rax</code></li>
<li>Set 2nd Parameter <code>unsigned long</code> to <code>$16</code> as the object (<code>DerivedC</code>) size we will delete is of 16 bytes</li>
<li>Set 1st Parameter <code>void*</code> to <code>%rax</code> (<code>Base* base</code>)</li>
<li>Call <code>delete</code></li>
</ol>
</li>
<li>
<p>Set Return Value</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</code></pre></div><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">    <span style="color:#a6e22e">movl</span>    <span style="color:#66d9ef">$0</span>, %eax
</code></pre></div></li>
<li>
<p>Restore Stack Frame and Return</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-asm" data-lang="asm">    <span style="color:#a6e22e">addq</span>    <span style="color:#66d9ef">$24</span>, %rsp
    <span style="color:#a6e22e">popq</span>    %rbx
    <span style="color:#a6e22e">popq</span>    %rbp
    <span style="color:#a6e22e">ret</span>
</code></pre></div></li>
</ol>


    

    


</article>

<div id="gitalk-container"></div>



        </div>

        <aside class="col-12 col-lg-3 ml-auto blog-sidebar">
    
        


<section>
    <h4>Recent Posts</h4>
    <ol class="list-unstyled">
        
        <li>
            <a href="/en/post/">Posts</a>
        </li>
        
        <li>
            <a href="/en/2019/06/rvalue-reference-move-constructor-and-perfect-forwarding/">RValue-Reference, Move Constructor and Perfect Forwarding</a>
        </li>
        
        <li>
            <a href="/en/2019/05/c-virtual-table-explained-thru-assemblies/">C++ Virtual Table - Explained thru Assemblies</a>
        </li>
        
        <li>
            <a href="/en/2018/07/my-new-life/">My New Life</a>
        </li>
        
    </ol>
</section>

    
    
        <section>
    
        
        <h4>Categories</h4>
        <p>
            
            <a class="badge badge-primary" href="/en/categories/cpp">cpp</a>
            
            <a class="badge badge-primary" href="/en/categories/life">life</a>
            
        </p>
        
    
        
        <h4>Tags</h4>
        <p>
            
            <a class="badge badge-primary" href="/en/tags/cpp">cpp</a>
            
            <a class="badge badge-primary" href="/en/tags/jottings">jottings</a>
            
            <a class="badge badge-primary" href="/en/tags/rvalue">rvalue</a>
            
            <a class="badge badge-primary" href="/en/tags/virtual-table">virtual-table</a>
            
        </p>
        
    
</section>
    
</aside>

      </div>
    </div>
    

    
    






<footer class="blog-footer w-100">
    <nav class="navbar navbar-light bg-light">
        <p class="w-100 text-center"><a href="https://beian.miit.gov.cn" target="_blank">Hongxu Xu © 2020 苏ICP备2021014763号-1</a></p>
        <p class="w-100 text-center"><a href="#">Back to top</a></p>
    </nav>
</footer>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
    inlineMath: [['$','$'], ['\\(','\\)']],
    displayMath: [['$$','$$']],
    processEscapes: true,
    processEnvironments: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    TeX: { equationNumbers: { autoNumber: "AMS" },
            extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
});
</script>

<script type="text/x-mathjax-config">
MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax();
    for(var i = 0; i != all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
    }
});
</script>

<script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<script type="text/javascript">
    String.prototype.trimEnd = function (str) {
        if (this.endsWith(str)) {
            return this.substring(0, this.length - str.length);
        }
        return this;
    }

    function cleanedHref() {
        var res = location.href.trim();
        var regex = /(index\.html?|[#/])+$/gi;
        return res.replace(regex, '')
    }

    var gitalk = new Gitalk({
        clientID: 'dd67fbd38a74844e6dce',
        clientSecret: '7278e4bf15c952b3491d7c61716b9672962f4460',
        repo: 'xuhongxu96.github.io',
        owner: 'xuhongxu96',
        admin: ['xuhongxu96'],
        id: "4ae817299735f5f90d6f627bfed6a087",      
        distractionFreeMode: true  
    })

    gitalk.render('gitalk-container')
</script>
    

    
    
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.bootcss.com/popper.js/1.15.0/umd/popper.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.bootcss.com/twitter-bootstrap/4.3.1/js/bootstrap.min.js" crossorigin="anonymous"></script>
</body>

</html>